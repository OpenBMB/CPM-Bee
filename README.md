
<div align="center">

# CPM-Bee

**ç™¾äº¿å‚æ•°çš„å¼€æºä¸­è‹±æ–‡åŒè¯­åŸºåº§å¤§æ¨¡å‹**

<p align="center">
  <a href="#æ¨¡å‹">æ¨¡å‹</a> â€¢
  <a href="#é¢„è®­ç»ƒ">OpenBMBä½“ç³»</a> â€¢
  <a href="#é›¶æ ·æœ¬è¯„æµ‹">æ€§èƒ½è¡¨ç°</a> â€¢
  <a href="#æ¨¡å‹åè®®">å¼€æºåè®®</a>
</p>

</div>


## âœ¨ æ¨¡å‹ä»‹ç»

**CPM-Bee**æ˜¯ä¸€ä¸ªå®Œå…¨å¼€æºã€å…è®¸å•†ç”¨çš„ç™¾äº¿å‚æ•°ä¸­è‹±æ–‡åŸºåº§æ¨¡å‹ï¼Œä¹Ÿæ˜¯[**CPM-Live**](https://live.openbmb.org/)è®­ç»ƒçš„ç¬¬äºŒä¸ªé‡Œç¨‹ç¢‘ã€‚å®ƒé‡‡ç”¨Transformerè‡ªå›å½’æ¶æ„ï¼ˆauto-regressiveï¼‰ï¼Œåœ¨è¶…ä¸‡äº¿ï¼ˆtrillionï¼‰é«˜è´¨é‡è¯­æ–™ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œæ‹¥æœ‰å¼ºå¤§çš„åŸºç¡€èƒ½åŠ›ã€‚å¼€å‘è€…å’Œç ”ç©¶è€…å¯ä»¥åœ¨CPM-BeeåŸºåº§æ¨¡å‹çš„åŸºç¡€ä¸Šåœ¨å„ç±»åœºæ™¯è¿›è¡Œé€‚é…æ¥ä»¥åˆ›å»ºç‰¹å®šé¢†åŸŸçš„åº”ç”¨æ¨¡å‹ã€‚

- **ğŸ‘ å¼€æºå¯å•†ç”¨**ï¼šOpenBMBå§‹ç»ˆç§‰æ‰¿â€œè®©å¤§æ¨¡å‹é£å…¥åƒå®¶ä¸‡æˆ·â€çš„å¼€æºç²¾ç¥ï¼ŒCPM-BeeåŸºåº§æ¨¡å‹å°†å®Œå…¨å¼€æºå¹¶ä¸”å¯å•†ç”¨ï¼Œä»¥æ¨åŠ¨å¤§æ¨¡å‹é¢†åŸŸçš„å‘å±•ã€‚æˆ‘ä»¬é¼“åŠ±å…¨çƒèŒƒå›´å†…çš„ç§‘ç ”æœºæ„ã€ä¼ä¸šå’Œä¸ªäººå¼€å‘è€…åœ¨éµå®ˆ[å¼€æºè®¸å¯åè®®](#æ¨¡å‹åè®®)çš„å‰æä¸‹ï¼Œè‡ªç”±åœ°åœ¨CPM-BeeåŸºåº§æ¨¡å‹ä¸Šè¿›è¡Œåˆ›æ–°ã€‚

- **ğŸ’« ä¸­è‹±åŒè¯­æ€§èƒ½ä¼˜å¼‚**ï¼šCPM-BeeåŸºåº§æ¨¡å‹åœ¨é¢„è®­ç»ƒè¯­æ–™ä¸Šè¿›è¡Œäº†ä¸¥æ ¼çš„ç­›é€‰å’Œé…æ¯”ï¼ŒåŒæ—¶åœ¨ä¸­è‹±åŒè¯­ä¸Šå…·æœ‰äº®çœ¼è¡¨ç°ï¼Œå…·ä½“å¯å‚è§[è¯„æµ‹ä»»åŠ¡å’Œç»“æœ](#é›¶æ ·æœ¬è¯„æµ‹)ã€‚

- **ğŸ“– è¶…å¤§è§„æ¨¡é«˜è´¨é‡è¯­æ–™**ï¼šCPM-BeeåŸºåº§æ¨¡å‹åœ¨è¶…ä¸‡äº¿è¯­æ–™è¿›è¡Œè®­ç»ƒï¼Œæ˜¯å¼€æºç¤¾åŒºå†…ç»è¿‡è¯­æ–™æœ€å¤šçš„æ¨¡å‹ä¹‹ä¸€ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯¹é¢„è®­ç»ƒè¯­æ–™è¿›è¡Œäº†ä¸¥æ ¼çš„ç­›é€‰ã€æ¸…æ´—å’Œåå¤„ç†ä»¥ç¡®ä¿è´¨é‡ã€‚

- **<img src="https://i.imgloc.com/2023/05/21/V4nLS3.png" width="20px"> OpenBMBå¤§æ¨¡å‹ç³»ç»Ÿç”Ÿæ€æ”¯æŒ**ï¼šOpenBMBå¤§æ¨¡å‹ç³»ç»Ÿå›´ç»•é«˜æ€§èƒ½é¢„è®­ç»ƒã€é€‚é…ã€å‹ç¼©ã€æ¨ç†å¼€å‘äº†ä¸€ç³»åˆ—å·¥å…·ï¼ŒCPM-BeeåŸºåº§æ¨¡å‹å°†é…å¥—æ‰€æœ‰çš„å·¥å…·è„šæœ¬ï¼Œé«˜æ•ˆæ”¯æŒå¼€å‘è€…è¿›è¡Œè¿›é˜¶ä½¿ç”¨ã€‚


- **ğŸ”¨ å¯¹è¯å’Œå·¥å…·ä½¿ç”¨èƒ½åŠ›**ï¼š ç»“åˆOpenBMBåœ¨æŒ‡ä»¤å¾®è°ƒå’Œå·¥å…·å­¦ä¹ çš„æ¢ç´¢ï¼Œæˆ‘ä»¬åœ¨CPM-BeeåŸºåº§æ¨¡å‹çš„åŸºç¡€ä¸Šè¿›è¡Œå¾®è°ƒï¼Œè®­ç»ƒå‡ºäº†å…·æœ‰å¼ºå¤§å¯¹è¯å’Œå·¥å…·ä½¿ç”¨èƒ½åŠ›çš„å®ä¾‹æ¨¡å‹ï¼ŒAPIå’Œå†…æµ‹å°†äºè¿‘æœŸå¼€æ”¾ã€‚


*Read this in [English](https://github.com/OpenBMB/CPM-Bee/blob/main/README_en.md).*


è¯´æ˜ï¼šCPM-Beeæ˜¯ä¸€ä¸ª**åŸºåº§**æ¨¡å‹ï¼Œå³ä»é›¶å¼€å§‹é€šè¿‡**é¢„è®­ç»ƒ**å¾—æ¥ã€‚æˆ‘ä»¬é¼“åŠ±ç”¨æˆ·åœ¨è‡ªå·±çš„åœºæ™¯å’Œæ•°æ®ä¸Š**é€‚é…/å¾®è°ƒ/å¯¹é½**åå†è¿›è¡Œä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œ[WebCPM](https://github.com/thunlp/WebCPM) ä»¥CPM-Beeä¸ºåŸºåº§ï¼Œåœ¨äººç±»ç½‘ç»œæ£€ç´¢çš„åºåˆ—åŒ–æ•°æ®ä¸Šè¿›è¡Œé€‚é…ï¼Œè·å¾—äº†å¤æ‚é—®ç­”å’Œä¸Šç½‘æ£€ç´¢çš„èƒ½åŠ›ã€‚åç»­æˆ‘ä»¬å°†ä¼šå‘å¸ƒæ›´å¤šåœ¨CPM-BeeåŸºåº§æ¨¡å‹åŸºç¡€ä¸Šé€‚é…çš„æ¨¡å‹ã€‚

<div align="center">
  <img src="https://i.imgloc.com/2023/06/07/VwgLLN.png" width="660px">
  <div align="center">
  æœ¬ä»“åº“ä¸»è¦æä¾› CPM-Bee åŸºåº§æ¨¡å‹
  </div>
</div>


## ğŸ“° æ›´æ–°ä¿¡æ¯

- **[2023/06/30]**  åŸºäºCPM-Beeçš„å¤šæ¨¡æ€ç³»åˆ—æ¨¡å‹[VisCPM](https://github.com/OpenBMB/VisCPM)å‘å¸ƒï¼Œæ”¯æŒå¤šæ¨¡æ€å¯¹è¯å’Œæ–‡ç”Ÿå›¾ï¼
- **[2023/06/16]**  CPM-Beeç°å·²æ”¯æŒğŸ¤—[Transformers](https://huggingface.co/openbmb/cpm-bee-10b)ã€‚
- **[2023/06/08]**  æ›´æ–°äº†ä½¿ç”¨CPM-Beeè¿›è¡ŒåŸºç¡€ä»»åŠ¡å¾®è°ƒçš„[æ•™ç¨‹](https://github.com/OpenBMB/CPM-Bee/tree/main/tutorials/basic_task_finetune)ã€‚
- **[2023/05/27]**  ç™¾äº¿å‚æ•°ï¼Œå…è®¸å•†ç”¨çš„ä¸­è‹±åŒè¯­åŸºåº§æ¨¡å‹CPM-Beeå¼€æºäº†ï¼Œå®ƒæ˜¯[**CPM-Live**](https://live.openbmb.org/)çš„ç¬¬äºŒä¸ªé‡Œç¨‹ç¢‘ã€‚

## ğŸ¯ CPM-Beeç³»åˆ—æ¨¡å‹

| æ¨¡å‹ | æè¿° | 
| :---: | :---: | 
|[VisCPM](https://github.com/OpenBMB/VisCPM)| æ”¯æŒå¤šæ¨¡æ€å¯¹è¯å’Œå›¾æ–‡åŒå‘ç”Ÿæˆçš„å¼€æºä¸­è‹±åŒè¯­å¤šæ¨¡æ€å¤§æ¨¡å‹|
|[WebCPM](https://github.com/thunlp/WebCPM)| æ”¯æŒå¤æ‚é—®ç­”å’Œä¸Šç½‘æ£€ç´¢çš„å¼€æºä¸­æ–‡å¤§æ¨¡å‹|

## ğŸš€ å®‰è£…å’Œä½¿ç”¨
æ‚¨éœ€è¦å…‹éš†è¯¥ä»“åº“ï¼š
```bash
$ git clone -b main --single-branch https://github.com/OpenBMB/CPM-Bee.git
```
å¹¶ç¡®ä¿æ‚¨çš„ç¯å¢ƒç¬¦åˆè¦æ±‚ï¼š
```bash
- python>=3.7
- torch>=1.10,<2.0.0
```
æˆ‘ä»¬å»ºè®®ä½¿ç”¨Anacondaç®¡ç†ç¯å¢ƒå¹¶ä»PyPIå®‰è£…å…¶ä»–ä¾èµ–é¡¹ï¼š
```bash
$ cd src
$ pip install -r requirements.txt
```
æ³¨æ„**torchç‰ˆæœ¬éœ€ä¸CUDAç‰ˆæœ¬å¯¹åº”ï¼Œä¸ç„¶ä¼šå¼•èµ·å®‰è£…é”™è¯¯**ï¼Œå°¤å…¶æ˜¯torchä¹Ÿæ˜¯é€šè¿‡pip install -r requirements.txtè¿›è¡Œå®‰è£…æ—¶ï¼Œè¾ƒä¸ºå®¹æ˜“å‡ºç°è‡ªåŠ¨æ‹‰å–å®‰è£…çš„torchç‰ˆæœ¬ä¸æœ¬åœ°CUDAç‰ˆæœ¬ä¸å¯¹åº”ï¼Œå¯¼è‡´BMTrainæ— æ³•å®‰è£…ã€‚

### æ¨¡å‹

- [**10Bæ¨¡å‹ä¸‹è½½é“¾æ¥**](https://openbmb.oss-cn-hongkong.aliyuncs.com/model_center/cpm-bee-10b/cpm-bee-10b.zip)ï¼ˆå¦‚æœè¦ä½¿ç”¨ğŸ¤—Transformersè¿è¡Œæ¨¡å‹ï¼Œè¯·å‚è€ƒ[è¿™é‡Œ](https://huggingface.co/openbmb/cpm-bee-10b)ï¼‰ã€‚

### æ•°æ®æ ¼å¼
- ä¸åŒäºå·²æœ‰åŸºåº§æ¨¡å‹é‡‡ç”¨éç»“æ„åŒ–çš„è‡ªç”±æ–‡æœ¬å½¢å¼ç»„ç»‡æ•°æ®ï¼ŒCPM-Beeé‡‡ç”¨ç»“æ„åŒ–çš„jsonæ ¼å¼æ¥ç»„ç»‡æ•°æ®ã€‚å¯¹äºç»“æ„åŒ–æ•°æ®ï¼ŒCPM-Beeçš„åŸºåº§æ¨¡å‹å¯ä»¥å‡†ç¡®åœ°è¿›è¡Œè¯­ä¹‰ç†è§£ï¼Œé«˜æ•ˆå®Œæˆå„ç±»åŸºç¡€ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼šå¡«ç©ºã€æ–‡æœ¬ç”Ÿæˆã€ç¿»è¯‘ã€é—®ç­”ã€è¯„åˆ†é¢„æµ‹ã€æ–‡æœ¬é€‰æ‹©é¢˜ç­‰ç­‰ï¼Œä¸‹é¢ç»™å‡ºä¸€äº›ä»£è¡¨æ€§ä»»åŠ¡çš„æ¨¡æ¿ï¼š

```json
  "å¡«ç©º":{
    "input": "å¿ƒç†å­¦é¢†åŸŸçš„ç ”ç©¶äººå‘˜å‘ç°ï¼Œåšå‡ºé‡è¦å†³å®šçš„æœ€å¥½æ–¹æ³•ä¹‹ä¸€ï¼Œæ¯”å¦‚é€‰æ‹©ä¸€æ‰€å¤§å­¦æˆ–<mask_0>ï¼Œéƒ½æ¶‰åŠåˆ°ä½¿ç”¨å†³ç­–å·¥ä½œè¡¨ã€‚ç ”ç©¶ä¼˜åŒ–çš„å¿ƒç†å­¦å®¶å°†<mask_1>ä¸ç†è®ºç†æƒ³å†³ç­–è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹å®ƒä»¬æœ‰å¤šç›¸ä¼¼ã€‚å·¥ä½œè¡¨ç¨‹åºçš„æ”¯æŒè€…è®¤ä¸ºå®ƒä¼šäº§ç”Ÿæœ€ä¼˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å¥½çš„å†³ç­–ã€‚è™½ç„¶æœ‰<mask_2>å¯ä»¥æ¥å—ï¼Œä½†å®ƒä»¬åœ¨æœ¬è´¨ä¸Šéƒ½æ˜¯ç›¸ä¼¼çš„ã€‚",
    "<ans>":{
      "<mask_0>":"",
      "<mask_1>":"",
      "<mask_2>":""
    }
  }

  "æ–‡æœ¬ç”Ÿæˆ": {
    "input": "ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘å’Œå¦ˆå¦ˆä¸€èµ·å»å…¬å›­ï¼Œ", 
    "prompt": "å¾€åå†™çº¦100å­—", 
    "<ans>": ""
  }

  "ç¿»è¯‘": {
    "input": "åŒ—äº¬æ˜¯ä¸­å›½çš„é¦–éƒ½", 
    "prompt": "ä¸­ç¿»è‹±", 
    "<ans>": ""
  }

  "é—®ç­”": {
    "input": "NGC 6231æ˜¯ä¸€ä¸ªä½äºå¤©èåº§çš„ç–æ•£æ˜Ÿå›¢ï¼Œå¤©çƒåº§æ ‡ä¸ºèµ¤ç»16æ—¶54åˆ†ï¼Œèµ¤çº¬-41åº¦48åˆ†ï¼Œè§†è§‰è§‚æµ‹å¤§å°çº¦45è§’åˆ†ï¼Œäº®åº¦çº¦2.6è§†æ˜Ÿç­‰ï¼Œè·åœ°çƒ5900å…‰å¹´ã€‚NGC 6231å¹´é¾„çº¦ä¸ºä¸‰ç™¾äºŒåä¸‡å¹´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¹´è½»çš„æ˜Ÿå›¢ï¼Œæ˜Ÿå›¢å†…çš„æœ€äº®æ˜Ÿæ˜¯5ç­‰çš„å¤©èåº§ Î¶1æ˜Ÿã€‚ç”¨åŒç­’æœ›è¿œé•œæˆ–å°å‹æœ›è¿œé•œå°±èƒ½çœ‹åˆ°ä¸ªåˆ«çš„è¡Œæ˜Ÿã€‚NGC 6231åœ¨1654å¹´è¢«æ„å¤§åˆ©å¤©æ–‡å­¦å®¶ä¹”ç“¦å°¼Â·å·´è’‚æ–¯ç‰¹Â·éœè¿ªå°”çº³ï¼ˆGiovanni Battista Hodiernaï¼‰ä»¥Luminosaeçš„åå­—é¦–æ¬¡çºªå½•åœ¨æ˜Ÿè¡¨ä¸­ï¼Œä½†æ˜¯æœªè§è®°è½½äºå¤å°”Â·æ¢…è¥¿è€¶çš„å¤©ä½“åˆ—è¡¨å’Œå¨å»‰Â·èµ«æ­‡å°”çš„æ·±ç©ºå¤©ä½“ç›®å½•ã€‚è¿™ä¸ªå¤©ä½“åœ¨1678å¹´è¢«çˆ±å¾·è’™Â·å“ˆé›·ï¼ˆI.7ï¼‰ã€1745å¹´è¢«å¤è¥¿äºšç§‘æ–¯ï¼ˆJean-Phillippe Loys de Cheseauxï¼‰ï¼ˆ9ï¼‰ã€1751å¹´è¢«å°¼å¯æ‹‰Â·è·¯æ˜“Â·æ‹‰å¡ä¼Šï¼ˆII.13ï¼‰åˆ†åˆ«å†æ¬¡ç‹¬ç«‹å‘ç°ã€‚", 
    "question": "NGC 6231çš„ç»çº¬åº¦æ˜¯å¤šå°‘ï¼Ÿ", 
    "<ans>": ""
  }

  "è¯„åˆ†é¢„æµ‹": {
    "input":"ä¹‹å‰å¤šæ¬¡èšé¤éƒ½é€‰æ‹©è¿™é‡Œï¼Œæœ‰å„ç§å¤§å°çš„åŒ…æˆ¿åŒæ—¶èƒ½å®¹çº³å¾ˆå¤šäººï¼Œç¯å¢ƒå¥½æœ‰ç‰¹è‰²è¿˜æœ‰è¡¨æ¼”ï¼Œæ•´ä½“èšé¤æ°›å›´ä¸€ä¸‹è¢«å¸¦åŠ¨èµ·æ¥ã€‚ç°åœ¨ç”±äºç‚­ç«æ”¹æˆäº†ç”µçƒ¤ç¾Šï¼Œå£æ„ŸçœŸçš„ä¸å¦‚ä»å‰ï¼Œä¸è¿‡å…¶ä»–èœå“éƒ½è¿˜æ˜¯ä¸é”™ï¼Œçƒ¤ç¾Šå‰©ä¸‹çš„æ‹†éª¨è‚‰æœ€åè¿˜èƒ½å†åŠ å·¥ä¸€ä¸‹æ¤’ç›çš„ä¹Ÿå¾ˆå¥½åƒã€‚",
    "question":"è¯„åˆ†æ˜¯å¤šå°‘ï¼Ÿ(1-5)",
    "<ans>":""
  }

  "é€‰æ‹©é¢˜": {
    "input": "çˆ¶æ¯éƒ½å¸Œæœ›è‡ªå·±çš„å­©å­è¯šå®ã€å‹‡æ•¢ã€æœ‰ç¤¼è²Œã€‚è¦æƒ³è®©å­©å­æˆä¸ºè¿™æ ·çš„äººï¼Œçˆ¶æ¯é¦–å…ˆå¾—ä»è‡ªå·±åšèµ·ï¼Œè¦æ˜¯è¿è‡ªå·±éƒ½åšä¸åˆ°ï¼Œåˆæ€èƒ½è¦æ±‚å­©å­åšåˆ°å‘¢ï¼Ÿ", 
    "options": {
      "<option_0>": "å°‘æè¦æ±‚", 
      "<option_1>": "é™ä½æ ‡å‡†",
      "<option_2>": "è‡ªå·±å…ˆåšå¥½",
      "<option_3>": "è®©å­©å­æ‹¿ä¸»æ„"
    }, 
    "question": "æ•™è‚²å­©å­æ—¶ï¼Œçˆ¶æ¯åº”è¯¥ï¼š", 
    "<ans>": ""
  }
```

- **æ³¨æ„**åœ¨æ¨¡å‹æ¨ç†æ—¶å¯é‡‡ç”¨ä¸Šè¿°æ¨¡æ¿ï¼Œåœ¨æ¨¡å‹è®­ç»ƒæ—¶éœ€åœ¨<ans>ä¸­""å¤„å¡«ä¸Šæ ‡å‡†ç­”æ¡ˆï¼Œå¦‚ï¼š

```json
  {
    "input": "åŒ—äº¬æ˜¯ä¸­å›½çš„é¦–éƒ½", 
    "prompt": "ä¸­ç¿»è‹±", 
    "<ans>": "Beijing is the capital of China"
  }


  {
    "input": "çˆ¶æ¯éƒ½å¸Œæœ›è‡ªå·±çš„å­©å­è¯šå®ã€å‹‡æ•¢ã€æœ‰ç¤¼è²Œã€‚è¦æƒ³è®©å­©å­æˆä¸ºè¿™æ ·çš„äººï¼Œçˆ¶æ¯é¦–å…ˆå¾—ä»è‡ªå·±åšèµ·ï¼Œè¦æ˜¯è¿è‡ªå·±éƒ½åšä¸åˆ°ï¼Œåˆæ€èƒ½è¦æ±‚å­©å­åšåˆ°å‘¢ï¼Ÿ", 
    "options": {
      "<option_0>": "å°‘æè¦æ±‚", 
      "<option_1>": "é™ä½æ ‡å‡†",
      "<option_2>": "è‡ªå·±å…ˆåšå¥½",
      "<option_3>": "è®©å­©å­æ‹¿ä¸»æ„"
    }, 
    "question": "æ•™è‚²å­©å­æ—¶ï¼Œçˆ¶æ¯åº”è¯¥ï¼š", 
    "<ans>": "<option_2>"
  }
```

- CPM-Beeåœ¨é¢„è®­ç»ƒé˜¶æ®µæ³¨å…¥äº†ä¸€äº›jsonæ ¼å¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·è‡ªå·±è®¾è®¡jsonæ ¼å¼ç„¶åå¾®è°ƒæ¨¡å‹ã€‚æ‰€æœ‰çš„jsonæ ¼å¼éœ€è¦æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ï¼š
    - è¾“å‡ºå†…å®¹**å¿…é¡»**ä½¿ç”¨<ans>ä½œä¸ºé”®å€¼æ¥ç»„ç»‡ï¼›
    - é€‰æ‹©é¢˜çš„é€‰é¡¹å»ºè®®ä½¿ç”¨<option_xx>æ¥ç»„ç»‡ï¼Œä¸”xxä¸ºæ•°å­—ï¼›
    - å¡«ç©ºé¢˜çš„ç©ºç™½å»ºè®®ä½¿ç”¨<mask_xx>æ¥ç»„ç»‡ï¼Œä¸”xxä¸ºæ•°å­—ï¼›
    - å› ä¸º"<"åœ¨CPM-Beeä¸­ä¼šä½œä¸ºè¯†åˆ« <ans>ã€<option_xx>ã€<mask_xx>çš„è§¦å‘ç¬¦ï¼Œæ‰€ä»¥åœ¨æ•°æ®ä¸­æ–‡ä¸­**å¿…é¡»**å°†"<"è½¬åŒ–ä¸º"<<"è¿›è¡Œè½¬ä¹‰ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­"1 < 2"ã€"10 < 8"è¢«è½¬å†™ä¸º"1 << 2"ã€"10 << 8"ï¼š

```
  {
    "question": "ä¸‹é¢å“ªé¡¹æ˜¯æ­£ç¡®çš„", 
    "options": {
      "<option_0>": "1 << 2", 
      "<option_1>": "10 << 8",
    }, 
    "<ans>": "<option_0>"
  }
```

## æ¨¡å‹é¢„è®­ç»ƒ

1. **æ•°æ®æ¸…æ´—**
    - éœ€è¦å°†æ¯ä¸ªæ ·æœ¬æ”¾ç½®ä¸ºä¸€è¡Œï¼Œæ¢è¡Œè¿›è¡Œè½¬ä¹‰å˜ä¸º\\nï¼Œæ ¼å¼å¯ä¸ºtxtä¹Ÿå¯ä¸ºjsonï¼Œä¾‹å¦‚ï¼š
        - txtæ ¼å¼
        ```
            ...
            ...
            How can cross training benefit groups like runners, swimmers, or weightlifters?\n\n1. Reduces the risk of injury...\n\n2. Improves overall fitness...
            Are there any particular physical benefits to mindful walking, such as improved posture or increased physical fitness?\n\n1. Choose a quiet and peaceful environment...\n\n2. Start by tuning into your breath and becoming aware of your surroundings...
            ... 
            ...
        ```
        - jsonæ ¼å¼
        ```
            ...
            ...
            {"template": "Does the answer correctly answer the question", "sentence": "Unicode has the explicit aim of transcending ...", "question": "What is the aim of Unicode?", "options": {"<option_0>": "no", "<option_1>": "yes"}, "<ans>": "<option_1>"}
            ... 
            ...
        ```
    - **æ¡ˆä¾‹**ï¼šæˆ‘ä»¬æä¾›äº†[wiki(txtæ ¼å¼ï¼Œçº¯æ–‡æœ¬)](https://pan.baidu.com/s/4jNUmqpC)å’Œ[flan(jsonæ ¼å¼ï¼Œé€‰æ‹©é¢˜)](https://pan.baidu.com/s/4jNUmqpC)çš„æ ·ä¾‹ï¼Œå¯ä»¥ä¸‹è½½åæŒ‰ä¸‹åˆ—æ–‡ä»¶è·¯å¾„ä¸­çš„raw_dataè¿›è¡Œæ–‡ä»¶ç»„ç»‡ï¼Œå®Œæˆåç»­æ­¥éª¤çš„å°è¯•ã€‚
    - ```
        CPMBee/
        â”œâ”€â”€ src
        |   â””â”€â”€ ...
        â””â”€â”€ raw_dataï¼ˆåŸå§‹æ•°æ®ä½ç½®ï¼‰
            â”œâ”€â”€ wiki
            |   â””â”€â”€ raw.txtï¼ˆtxtåŸå§‹æ•°æ®ï¼‰
            â””â”€â”€ flan
                â””â”€â”€ raw.jsonï¼ˆjsonåŸå§‹æ•°æ®ï¼‰
        ```

2. æ•°æ®é›†ç”Ÿæˆ
    - CPMBeeä¸ºäº†é«˜æ•ˆè¯»å–æ•°æ®ä»¥åŠåœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œæ•°æ®é›†éƒ¨ç½²ï¼Œéœ€è¦å°†å…¶è½¬åŒ–æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…·ä½“è°ƒç”¨srcä¸‹çš„build_dataset.pyï¼Œå…·ä½“å‚æ•°åŒ…æ‹¬ï¼š
        - --input-path: å¯¼å…¥çš„åŸå§‹æ•°æ®è·¯å¾„ï¼Œç¨‹åºä¼šå°†è·¯å¾„ä¸‹çš„æ–‡ä»¶ç»Ÿä¸€æ‰“åŒ…è¿›è¡Œå¤„ç†
        - --output-path: å¯¼å‡ºçš„æ•°æ®é›†è·¯å¾„
        - --output-name: å¯¼å‡ºçš„æ•°æ®é›†åç§°
        - --data-type: txt/json
        - --min-length: å°äºæœ€å°é•¿åº¦çš„æ•°æ®å°†è¢«æŠ›å¼ƒ
        - --max-length: è¶…è¿‡æœ€å¤§é•¿åº¦çš„æ•°æ®å°†è¢«åˆ‡åˆ†
        - txtæ ¼å¼çš„åŸå§‹æ•°æ®å°†æŒ‰ç…§min-lengthå’Œmax-lengthè¿›è¡Œåˆ‡åˆ†ï¼Œç„¶åç»Ÿä¸€ä»¥{'text':'......'}çš„jsonæ ¼å¼å¯¼å‡ºåˆ°æ•°æ®é›†
    - å¯¼å‡ºçš„æ•°æ®é›†å°†æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªåä¸ºoutput-nameçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸€ä¸ªmeta.binæ–‡ä»¶ï¼Œmeta.binæ–‡ä»¶ä¸­è®°å½•äº†output-nameçš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
        - "file_name": meta.binå¯¹åº”çš„æ–‡ä»¶åï¼Œä¸€èˆ¬å°±æ˜¯output-name
        - "block_begin": æ•°æ®é›†æŒ‰å—åˆ†å¸ƒå­˜å‚¨ï¼Œæ•°æ®é›†æ‰€åœ¨çš„å¼€å§‹å—ï¼Œä¸€èˆ¬æ˜¯0
        - "block_end": æ•°æ®é›†æŒ‰å—åˆ†å¸ƒå­˜å‚¨ï¼Œæ•°æ®é›†æ‰€åœ¨çš„ç»“æŸå—ï¼Œä¸€èˆ¬æ˜¯æ€»å—æ•°  
        - "nbytes": 60221163, æ€»çš„æ•°æ®é›†å¤§å°
        - "nlines": 41733, æ€»çš„æ•°æ®é›†è¡Œæ•°
        - "block_size": 16777216ï¼Œæ•°æ®é›†æ¯å—å¤§å°
    - **æ¡ˆä¾‹**ï¼šæˆ‘ä»¬å°†æ ·ä¾‹ç»™å®šçš„wikiå’Œflanç”Ÿæˆä¸ºæ•°æ®é›†ï¼š
    - ```bash
        $ cd CPMBee/src
        $ python build_dataset.py --input-path ../raw_data/wiki/  --output-path ../datasets/wiki/ --output-name wiki --data-type txt --min-length 100 --max-length 10000
        $ python build_dataset.py --input-path ../raw_data/flan/  --output-path ../datasets/flan/ --output-name flan --data-type json
        ```
        - ç”Ÿæˆä¹‹åçš„æ–‡ä»¶ç»“æ„ä¸ºï¼š
        ```
        CPMBee/
        â”œâ”€â”€ src
        |   â”œâ”€â”€ ...
        |   â””â”€â”€ build_dataset.py
        â”œâ”€â”€ raw_data
        |   â”œâ”€â”€ wiki
        |   |   â””â”€â”€ raw.txt
        |   â””â”€â”€ flan
        |       â””â”€â”€ raw.json
        â””â”€â”€ datasetsï¼ˆç”Ÿæˆçš„æ•°æ®é›†ï¼‰
            â”œâ”€â”€ wikiï¼ˆwikiå¯¹åº”çš„æ•°æ®é›†ï¼‰
            |   â””â”€â”€ data
            |       â”œâ”€â”€ wiki
            |       â””â”€â”€ meta.bin
            â””â”€â”€ flanï¼ˆflanå¯¹åº”çš„æ•°æ®é›†ï¼‰
                â””â”€â”€ data
                    â”œâ”€â”€ flan
                    â””â”€â”€ meta.bin
        ```
3. ä»»åŠ¡è½¬æ¢è„šæœ¬
    - å¯¹äºæ¯ä¸ªæ•°æ®é›†ï¼Œå¯ä»¥æ’°å†™ä»»åŠ¡è½¬æ¢è„šæœ¬æ¥å¯¹æ•°æ®é›†ä¸­çš„jsonæ ¼å¼è¿›è¡Œæ”¹å†™ï¼Œæ”¹å†™æˆå„ç±»é¢„è®­ç»ƒä»»åŠ¡ã€‚
    - è„šæœ¬æ ¼å¼éœ€æ»¡è¶³ä»¥ä¸‹æ ¼å¼ï¼š
        ```python
            import random
            
            def transform(data, num_sample: int, r: random.Random):
                ...
        ```
        - å¯¹äºæ¯ä¸ªæ•°æ®é›†ï¼ŒCPMBeeçš„åº•å±‚æ–‡ä»¶ç³»ç»Ÿå°†ä¼šè‡ªåŠ¨å¯¼å…¥æ•°æ®é›†ï¼Œè¯»å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨ä»»åŠ¡è½¬æ¢è„šæœ¬è¿›è¡Œæ”¹é€ ã€‚
        - è½¬æ¢è„šæœ¬åŒ…å«ä¸‰ä¸ªè¾“å…¥å‚æ•°ï¼Œdataä¸ºè¯»å‡ºæ ·æœ¬ï¼Œnum_sampleä¸ºè¯»å‡ºçš„æ ·æœ¬æ•°é‡ï¼ˆé€šå¸¸ä¸º1æ¡ï¼Œin-context learningè®¾å®šä¸‹ä¼šæœ‰å¤šæ¡ï¼‰ï¼Œrä¸ºéšæœºç”Ÿæˆå™¨ã€‚
    - **æ¡ˆä¾‹**ï¼šé’ˆå¯¹wikiå’Œflanå†™è½¬æ¢è„šæœ¬ï¼š
        - wikiè„šæœ¬
        ```python
        import random
        
        def rand(n: int, r: random.Random):
            return int(r.random() * n)
        
        def transform(data, num_sample: int, r: random.Random):
            # æŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤ï¼Œwikiä¸­çš„æ•°æ®éƒ½ä¸º{'text':'...'}å½¢å¼
            text = data['text']
            # éšæœºé®è”½50%~100%çš„å†…å®¹è¿›è¡Œé¢„æµ‹
            mid = rand(len(text) // 2, r)
            # CPMBeeéœ€è¦<æ¥è¯†åˆ«ç‰¹æ®Šé”®ï¼Œæ‰€ä»¥éœ€è¦å°†å†…å®¹ä¸­çš„<è½¬æ¢ä¸º<<è¿›è¡Œè½¬ä¹‰
            ipt = text[:mid].replace("<", "<<")
            ans = text[mid:].replace("<", "<<")
            return {"input": ipt,
                    "<ans>": ans}
        ```
        - flanè„šæœ¬
        ```python
        import random
        
        def transform(data, num_sample: int, r: random.Random):
            # æŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤ï¼Œflanä¸­çš„æ•°æ®å·²ç»æ˜¯é€‰æ‹©é¢˜çš„jsonæ ¼å¼äº†ï¼Œä¸”åŒ…å«<ans>é”®ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›è¿›è¡Œè®­ç»ƒ
            return data
        ```
        - å†™å®Œä»»åŠ¡è½¬æ¢è„šæœ¬åçš„æ–‡ä»¶ç»“æ„ä¸ºï¼š
        ```
        CPMBee/
        â”œâ”€â”€ src
        |   â”œâ”€â”€ ...
        |   â””â”€â”€ build_dataset.py
        â”œâ”€â”€ raw_data
        |   â”œâ”€â”€ wiki
        |   |   â””â”€â”€ raw.txt
        |   |
        |   â””â”€â”€ flan
        |       â””â”€â”€ raw.json
        â””â”€â”€ datasets
            â”œâ”€â”€ wiki
            |   â”œâ”€â”€ data
            |   |   â”œâ”€â”€ wiki
            |   |   â””â”€â”€ meta.bin
            |   â””â”€â”€ transform.pyï¼ˆwikiå¯¹åº”çš„ä»»åŠ¡è½¬æ¢è„šæœ¬ï¼‰
            â””â”€â”€ flan
                â”œâ”€â”€ data
                |   â”œâ”€â”€ flan
                |   â””â”€â”€ meta.bin
                â””â”€â”€ transform.pyï¼ˆflanå¯¹åº”çš„ä»»åŠ¡è½¬æ¢è„šæœ¬ï¼‰
        ```
4. æ•°æ®é›†è„šæœ¬
    - æ‰€æœ‰å‚ä¸è®­ç»ƒçš„æ•°æ®é›†éœ€è¦ä¸€ä¸ªæ•°æ®é›†è„šæœ¬æ¥è¿›è¡Œä¿¡æ¯æ±‡æ€»ï¼Œæ•°æ®é›†è„šæœ¬ä¹Ÿæ˜¯ä¸€ä¸ªjsonæ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹
    - ```json
        [
            {
                "dataset_name": "wiki",
                "task_name": "lm",
                "weight": 1.0,
                "path": "wiki/data",
                "incontext_weight": [1.0],
                "transforms": "wiki/transform.py"
            },
            {
                "dataset_name": "flan",
                "task_name": "nlu",
                "weight": 1.0,
                "path": "flan/data",
                "incontext_weight": [1.0],
                "transforms": "flan/transform.py"
            }
        ]
        ```
       - å…¶ä¸­ï¼ŒåŒ…å«å‚æ•°æœ‰ï¼š
           - dataset_name: æ•°æ®é›†åç§°ï¼›
           - task_name: æ•°æ®é›†æ‰€å±ä»»åŠ¡ï¼Œtask_name+dataset_nameå°†ä½œä¸ºè®­ç»ƒè¿‡ç¨‹ä¸­è¯†åˆ«æ•°æ®é›†çš„æ ‡ç­¾ï¼Œtask_nameåˆ™å¯ç”¨äºè®­ç»ƒè¿‡ç¨‹ä¸­é’ˆå¯¹ä»»åŠ¡åˆ†åˆ«æ±‡æ€»lossä¿¡æ¯ï¼›
           - weight: é‡‡æ ·æƒé‡ï¼›
           - path: meta.binã€äºŒè¿›åˆ¶æ•°æ®å¯¹åº”çš„è·¯å¾„ï¼›
           - transforms: ä»»åŠ¡è½¬æ¢è„šæœ¬å¯¹åº”çš„è·¯å¾„ï¼›
           - incontext_weight: è®­ç»ƒæ ·æœ¬å åŠ ï¼Œ[1.0]è¡¨ç¤º100%çš„æ¦‚ç‡é‡‡æ ·ä¸€ä¸ªæ ·æœ¬ï¼Œ[0.8, 0.2]è¡¨ç¤º20%æ¦‚ç‡é‡‡æ ·ä¸¤ä¸ªæ ·æœ¬è¿›è¡Œæ‹¼æ¥ï¼Œ[0.75, 0.1, 0.15]è¡¨ç¤º15%æ¦‚ç‡é‡‡æ ·ä¸‰ä¸ªæ ·æœ¬ã€10%çš„æ¦‚ç‡é‡‡æ ·ä¸¤ä¸ªæ ·æœ¬è¿›è¡Œæ‹¼æ¥ã€‚
       - **æ¡ˆä¾‹**ï¼šå†™å®Œæ•°æ®é›†è„šæœ¬æ±‡æ€»wikiå’Œflanæ•°æ®é›†åçš„æ–‡ä»¶è·¯å¾„ç»“æ„
        ```bash
        CPMBee/
        â”œâ”€â”€ src
        |   â”œâ”€â”€ ...
        |   â””â”€â”€ build_dataset.py
        â”œâ”€â”€ raw_data
        |   â”œâ”€â”€ wiki
        |   |   â””â”€â”€ raw.txt
        |   â””â”€â”€ flan
        |       â””â”€â”€ raw.json
        â””â”€â”€ datasets
            â”œâ”€â”€ datasets.jsonï¼ˆæ•°æ®é›†è„šæœ¬ï¼‰
            â”œâ”€â”€ wiki
            |   â”œâ”€â”€ data
            |   |   â”œâ”€â”€ wiki
            |   |   â””â”€â”€ meta.bin
            |   â””â”€â”€ transform.py
            â””â”€â”€ flan
                â”œâ”€â”€ data
                |   â”œâ”€â”€ flan
                |   â””â”€â”€ meta.bin
                â””â”€â”€ transform.py
        ```

5. é¢„è®­ç»ƒè„šæœ¬
    - é¢„è®­ç»ƒè„šæœ¬å¦‚ä¸‹
    - ```bash
        #! /bin/bash
        # æ¯å°æœºå™¨çš„å¡æ•°
        GPUS_PER_NODE=8
        # æœºå™¨å°æ•°
        NNODES=1
        # masteræœºå™¨çš„IPå’Œç«¯å£ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒpytorchåˆ†å¸ƒå¼è®­ç»ƒæ–‡æ¡£
        MASTER_ADDR="localhost"
        MASTER_PORT=12345
        
        OPTS=""
        # model and dataset settings
        # æ¨¡å‹é…ç½®
        OPTS+=" --model-config config/cpm-bee-10b.json"
        # æ­¥éª¤4æ•°æ®é›†è„šæœ¬ä½ç½®
        OPTS+=" --dataset ../datasets/datasets.json"
        # training settings
        # è®­ç»ƒæ­¥æ•°
        OPTS+=" --train-iters 200000"
        # å•å¡çš„batch size
        OPTS+=" --batch-size 2"
        # æ ·æœ¬æœ€å¤§é•¿åº¦ï¼Œæ³¨æ„CPMBeeåº•å±‚ä¼šæ‹¼æ¥æ•°æ®ç¡®ä¿max-lengthçš„åˆ©ç”¨æ•ˆç‡
        OPTS+=" --max-length 2048"
        # å­¦ä¹ ç‡ï¼Œå¦‚æœæ¥ç€ä¹‹å‰çš„ckptç»§ç»­è®­ç»ƒï¼Œå»ºè®®æ”¹å°
        OPTS+=" --lr 0.01"
        # warmupæ­¥æ•°
        OPTS+=" --warmup-iters 2000"
        # å­¦ä¹ ç‡ä¸‹é™çš„æœºåˆ¶
        OPTS+=" --lr-decay-style noam"
        # weight decayï¼Œè¿™ä¸ªä¼šç»“åˆåˆ°AdamWä¸­
        OPTS+=" --weight-decay 0.01"
        # æ¢¯åº¦è£å‰ªçš„èŒƒå›´
        OPTS+=" --clip-grad 1.0"
        # æ··åˆç²¾åº¦lossåŠ å€ç³»æ•°
        OPTS+=" --loss-scale 1048576"
        # æ··åˆç²¾åº¦lossåŠ å€ç³»æ•°çš„å¢é•¿/é™ä½å€æ•°
        OPTS+=" --loss-scale-factor 2"
        # æ¯éš”å¤šå°‘æ­¥lossåŠ å€ç³»æ•°è¿›è¡Œå¢é•¿
        OPTS+=" --loss-scale-steps 128"
        # log settings
        # æ¯éš”å¤šå°‘æ­¥æ‰“å°å‚æ•°å‡å€¼æ–¹å·®ã€æ¢¯åº¦å‡å€¼æ–¹å·®
        OPTS+=" --inspect-iters 100"
        # logæ–‡ä»¶è¾“å‡ºè·¯å¾„
        OPTS+=" --log-dir ../logs/train/"
        # tensorboardæ–‡ä»¶è¾“å‡ºè·¯å¾„
        OPTS+=" --tensorboard ../logs/tensorboard/cpm_live_48_4096/"
        # saving ckpts
        # æ¯éš”å¤šå°‘æ­¥è¾“å‡ºckpt
        OPTS+=" --save-iters 500"
        # è¾“å‡ºckptçš„è·¯å¾„
        OPTS+=" --save ../results/"
        # è¾“å‡ºckptçš„åç§°ï¼ŒCPMBeeåœ¨è¾“å‡ºckptæ—¶ä¼šæ‰“å°æ­¥æ•°
        OPTS+=" --save-name cpm_live_checkpoint"
        # loading ckptsï¼Œå¦‚æœåŠ è½½è€çš„ckptå°±æŠŠä¸‹åˆ—æ³¨é‡Šæ‰“å¼€ï¼Œç„¶åå¡«å†™MODEL_STEPS
        # MODEL_STEPS="0"
        # OPTS+=" --start-step ${MODEL_STEPS}"
        # OPTS+=" --load ../results/cpm_live_checkpoint-${MODEL_STEPS}.pt"
        # æ˜¯å¦åŠ è½½å†å²æ¢¯åº¦
        # OPTS+=" --load-grad "
        
        CMD="torchrun --nnodes=${NNODES} --nproc_per_node=${GPUS_PER_NODE} --rdzv_id=1 --rdzv_backend=c10d --rdzv_endpoint=${MASTER_ADDR}:${MASTER_PORT} pretrain_cpm_bee.py ${OPTS}"
        
        echo ${CMD}
        $CMD
        ```
    - **æ¡ˆä¾‹**ï¼šå†™å®Œé¢„è®­ç»ƒè„šæœ¬åçš„æ–‡ä»¶è·¯å¾„ç»“æ„
    - ```bash
        CPMBee/
        â”œâ”€â”€ src
        |   â”œâ”€â”€ scripts
        |   |      â””â”€â”€ pretrain_cpm_bee.shï¼ˆé¢„è®­ç»ƒè„šæœ¬ï¼‰
        |   â”œâ”€â”€ pretrain_cpm_bee.py
        |   â””â”€â”€ build_dataset.py
        â”œâ”€â”€ raw_data
        |   â”œâ”€â”€ wiki
        |   |   â””â”€â”€ raw.txt
        |   â””â”€â”€ flan
        |       â””â”€â”€ raw.json
        â””â”€â”€ datasets
            â”œâ”€â”€ datasets.json
            â”œâ”€â”€ wiki
            |   â”œâ”€â”€ data
            |   |   â”œâ”€â”€ wiki
            |   |   â””â”€â”€ meta.bin
            |   â””â”€â”€ transform.py
            â””â”€â”€ flan
                â”œâ”€â”€ data
                |   â”œâ”€â”€ flan
                |   â””â”€â”€ meta.bin
                â””â”€â”€ transform.py
        ```
6. é¢„è®­ç»ƒå‘½ä»¤
    - ```bash
        cd CPMBee/src
        bash scripts/pretrain_cpm_bee.sh
        ```
    - **æ¡ˆä¾‹**ï¼šå†™å®Œé¢„è®­ç»ƒè„šæœ¬åçš„æ–‡ä»¶è·¯å¾„ç»“æ„
    - ```bash
        CPMBee/
        â”œâ”€â”€ src
        |   â”œâ”€â”€ scripts
        |   |      â””â”€â”€ pretrain_cpm_bee.sh
        |   â”œâ”€â”€ pretrain_cpm_bee.py
        |   â””â”€â”€ build_dataset.py
        â”œâ”€â”€ resultsï¼ˆckptè¾“å‡ºè·¯å¾„ï¼‰
        â”œâ”€â”€ logsï¼ˆlogæ–‡ä»¶è¾“å‡ºè·¯å¾„ï¼‰                
        â”œâ”€â”€ raw_data
        |   â”œâ”€â”€ wiki
        |   |   â””â”€â”€ raw.txt
        |   â””â”€â”€ flan
        |       â””â”€â”€ raw.json
        â””â”€â”€ datasets
            â”œâ”€â”€ datasets.json
            â”œâ”€â”€ wiki
            |   â”œâ”€â”€ data
            |   |   â”œâ”€â”€ wiki
            |   |   â””â”€â”€ meta.bin
            |   â””â”€â”€ transform.py
            â””â”€â”€ flan
                â”œâ”€â”€ data
                |   â”œâ”€â”€ flan
                |   â””â”€â”€ meta.bin
                â””â”€â”€ transform.py
        ```

## <img src="https://i.imgloc.com/2023/05/21/V4nLS3.png" width="25px"> OpenBMB è¡ç”ŸåŠŸèƒ½

åŸºäºOpenBMBçš„å¤§æ¨¡å‹ç³»ç»Ÿç”Ÿæ€ï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒCPM-Beeçš„è¿‡ç¨‹ä¸­å®ç°äº†å…¨æµç¨‹é«˜æ•ˆã€‚åŒæ—¶æä¾›äº†æ¨¡å‹å¾®è°ƒï¼ˆåŸºäºBMTrainå’ŒOpenDeltaï¼‰ã€å·¥å…·ä½¿ç”¨ï¼ˆåŸºäºBMToolsï¼‰ã€æ¨¡å‹å‹ç¼©ï¼ˆåŸºäºBMCookï¼‰ã€ä½èµ„æºæ¨ç†ï¼ˆåŸºäºBMInfï¼‰çš„å…¨å¥—è„šæœ¬ï¼Œå¯ä»¥ååŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å’Œä½¿ç”¨CPM-Beeã€‚

### æ¨¡å‹å¾®è°ƒ

åŸºäº[BMTrain](https://github.com/OpenBMB/BMTrain)å’Œ[OpenDelta](https://github.com/thunlp/OpenDelta)ï¼Œæˆ‘ä»¬ç»™å‡ºäº†ä¸¤ç§å¾®è°ƒæ–¹æ¡ˆï¼šå…¨å‚æ•°å¾®è°ƒå’Œå‚æ•°é«˜æ•ˆçš„å¢é‡å¾®è°ƒï¼Œå¯ä»¥å°†CPM-Beeé€‚é…åˆ°å„ç±»ä¸‹æ¸¸åœºæ™¯ä¸­ã€‚

1. å…¨å‚æ•°å¾®è°ƒï¼š
```bash
$ torchrun --nnodes=1 --nproc_per_node=4 --rdzv_id=1 --rdzv_backend=c10d --rdzv_endpoint=localhost:12345 finetune_cpm_bee.py
```

2. å¢é‡å¾®è°ƒï¼š
```bash
$ torchrun --nnodes=1 --nproc_per_node=4 --rdzv_id=1 --rdzv_backend=c10d --rdzv_endpoint=localhost:12345 finetune_cpm_bee.py \
--use-delta \
```

**å¾®è°ƒæµç¨‹**

è¦åœ¨ç‰¹å®šä»»åŠ¡ä¸Šå¾®è°ƒæ¨¡å‹ï¼Œæ‚¨åº”è¯¥å‡†å¤‡æ•°æ®é›†å¹¶æŒ‰å¦‚ä¸‹æ–¹å¼æ‰§è¡Œï¼š
- è°ƒæ•´æ•°æ®æ ¼å¼ã€‚
  æ‚¨å¯ä»¥å°†åˆ†ç±»é—®é¢˜é›†æˆåˆ°é€‰æ‹©é¢˜çš„æ ¼å¼ä¸­ã€‚æœ‰å…³æ•°æ®æ ¼å¼çš„æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹[CPM-Beeæ•°æ®æ ¼å¼](#æ¨¡å‹)\
  åº”å½“æ³¨æ„ï¼Œç”±äºæˆ‘ä»¬é€‰å®š`<...>`ä½œä¸ºç‰¹æ®Štokençš„æ ‡è®°ï¼Œå¯èƒ½ä¸æ–‡æœ¬ä¸­çš„`<`æ··æ·†ï¼Œæ‰€ä»¥æ‚¨åº”å½“å¯¹æ–‡æœ¬æ•°æ®ä¸­çš„éç‰¹æ®Štokençš„éƒ¨åˆ†ï¼Œåšè½¬ä¹‰å¤„ç†ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹æ•°æ®
  ```json
  {"input": "å›¢é˜Ÿé…åˆéå¸¸é‡è¦ï¼Œå¦‚æœä¸èƒ½åšåˆ°<mask_0>ï¼Œåˆ™å¯èƒ½ä¼šé€ æˆ1+1<2çš„ç»“æœï¼Œæ‰€ä»¥ï¼Œè¦æ›´åŠ æ³¨æ„<mask_1>", "<ans>": {"<mask_0>": "", "<mask_1>": ""}}
  ```
  è¯¥æ•°æ®ä¸­ï¼Œ`<mask_0>`ä¸`<mask_1>`æ˜¯ç‰¹æ®Štokenï¼Œåº”ä¿æŒä¸å˜ï¼Œå…¶ä½™`<`å‡æ›¿æ¢ä¸º`<<`ï¼Œè½¬ä¹‰å¤„ç†åçš„æ•°æ®å¦‚ä¸‹:
  ```json
  {"input": "å›¢é˜Ÿé…åˆéå¸¸é‡è¦ï¼Œå¦‚æœä¸èƒ½åšåˆ°<mask_0>ï¼Œåˆ™å¯èƒ½ä¼šé€ æˆ1+1<<2çš„ç»“æœï¼Œæ‰€ä»¥ï¼Œè¦æ›´åŠ æ³¨æ„<mask_1>", "<ans>": {"<mask_0>": "", "<mask_1>": ""}}
  ```
- å°†æ•°æ®é›†é¢„å¤„ç†ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚
  è¦æ„å»ºé¢„å¤„ç†æ•°æ®é›†ï¼Œæ‚¨å¯ä»¥è¿è¡Œ

```bash
$ python preprocess_dataset.py --input your/reformated/data/path --output_path your/binary/data/path --output_name data_name
```
é¢„å¤„ç†åï¼Œæ‚¨å°†è·å¾—ï¼š
```
|-- your/binary/data/path
    |-- folder1
    |    |-- data_name
    |    |-- meta.bin
    |-- folder2
         |-- data_name
         |-- meta.bin
```
- å¾®è°ƒCPM-Bee
  è¦å¼€å§‹å¾®è°ƒï¼Œæ‚¨å¯ä»¥è¿è¡Œï¼š
``` bash
$ bash scripts/finetune_cpm_bee.sh
```
æˆ–è€…æ‚¨å¯ä»¥ç›´æ¥é€šè¿‡torchrunè¿è¡Œfinetune_cpm_bee.pyã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨å…·æœ‰4å—GPUçš„æœåŠ¡å™¨ä¸Šå¯¹CPM-Beeè¿›è¡Œå¢é‡å¾®è°ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```bash
torchrun --nnodes=1 --nproc_per_node=4 --rdzv_id=1 --rdzv_backend=c10d --rdzv_endpoint=localhost:12345 finetune_cpm_bee.py \
--model-config your/model/config/path \
--load your/model/checkpoint/path \
--dataset your/binary/data/path/folder1 \
--eval_dataset your/binary/data/path/folder2 \
--use-delta 
```

æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆå¾®è°ƒï¼ŒåŒæ—¶æ‚¨å¯ä»¥å‚è€ƒğŸ¤—[Transformers](https://huggingface.co/openbmb/cpm-bee-10b)ï¼Œä½¿ç”¨æ‚¨è‡ªå·±çš„å¹¶è¡ŒåŒ–ç­–ç•¥æ¥å¾®è°ƒCPM-Beeã€‚


### æ¨¡å‹å‹ç¼©

åŸºäº[BMCook](https://github.com/OpenBMB/BMCook)ï¼Œæˆ‘ä»¬å¯¹åŸå§‹çš„CPM-BeeåŸºåº§æ¨¡å‹è¿›è¡Œå‹ç¼©ï¼Œæä¾›äº†å¤šç§å¤§å°çš„CPM-Beeæ¨¡å‹æ¥é€‚åº”å„ç§ä¸åŒçš„åœºæ™¯ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸åŒå¤§å°çš„æ¨¡å‹éƒ½æä¾›äº†åŸºäºğŸ¤—Transformersçš„ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è¿›å…¥æ¨¡å‹ä»“åº“æŸ¥çœ‹æ›´å¤šä¿¡æ¯ã€‚

| æ¨¡å‹          | #Attnå±‚ | #FFNå±‚ | AttnéšçŠ¶æ€ç»´åº¦ | FFNéšçŠ¶æ€ç»´åº¦ | ä¸‹è½½                                       | ğŸ¤—Transformers
| ----------- | ------- | ----- | --------- | -------- | ---------------------------------------- | ---- |
| CPM-Bee-10B | 48      | 48    | 4096      | 10240    | [é“¾æ¥](https://openbmb.oss-cn-hongkong.aliyuncs.com/model_center/cpm-bee-10b/cpm-bee-10b.zip) | [é“¾æ¥](https://huggingface.co/openbmb/cpm-bee-10b) |
| CPM-Bee-5B  | 19      | 24    | 4096      | 10240    | [é“¾æ¥](https://openbmb.oss-cn-hongkong.aliyuncs.com/model_center/cpm-bee-5b/cpm-bee-5b.zip) | [é“¾æ¥](https://huggingface.co/openbmb/cpm-bee-5b) |
| CPM-Bee-2B  | 19      | 24    | 2048      | 5120     | [é“¾æ¥](https://openbmb.oss-cn-hongkong.aliyuncs.com/model_center/cpm-bee-2b/cpm-bee-2b.zip) | [é“¾æ¥](https://huggingface.co/openbmb/cpm-bee-2b) |
| CPM-Bee-1B  | 19      | 24    | 1280      | 1024     | [é“¾æ¥](https://openbmb.oss-cn-hongkong.aliyuncs.com/model_center/cpm-bee-1b/cpm-bee-1b.zip) | [é“¾æ¥](https://huggingface.co/openbmb/cpm-bee-1b) |


### æ¨¡å‹éƒ¨ç½²

å¯¹äºå‹ç¼©åçš„CPM-Beeï¼Œæ™®é€šçš„æ¶ˆè´¹çº§æ˜¾å¡å³å¯å®Œæˆå¿«é€Ÿæ¨ç†ï¼Œä¸åŒå¤§å°çš„æ¨¡å‹æ‰€å ç”¨çš„æ¨ç†èµ„æºå¦‚ä¸‹ï¼š

| æ¨¡å‹          | æ¨ç†æ˜¾å­˜å ç”¨ | æ¨èç¡¬ä»¶           |
| ----------- | ------ | -------------- |
| CPM-Bee-10B | 20GB   | RTX 3090ï¼ˆ24 GBï¼‰ |
| CPM-Bee-5B  | 11 GB  | RTX 3090ï¼ˆ24 GBï¼‰ |
| CPM-Bee-2B  | 6.7 GB | GTX 1080ï¼ˆ8 GBï¼‰ |
| CPM-Bee-1B  | 4.1 GB | GTX 1660ï¼ˆ6 GBï¼‰ |

#### ä½¿ç”¨æœ¬ä»“åº“
å¯¹äºå…·ä½“çš„æ¨ç†ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥æ ¹æ®å…‹éš†ä¸‹æ¥çš„CPM-Beeä»“åº“ç¼–å†™è‡ªå·±çš„æ¨ç†ä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬ä¸¾ä¸€ä¸ªç®€å•çš„æ–‡æœ¬ç”Ÿæˆç¤ºä¾‹ã€‚
```python
from cpm_live.generation.bee import CPMBeeBeamSearch
from cpm_live.models import CPMBeeTorch, CPMBeeConfig
from cpm_live.tokenizers import CPMBeeTokenizer
import torch

# prepare your input data.
data_list = [
    {"input": "ä»Šå¤©å¤©æ°”æ˜¯çœŸçš„", "prompt": "å¾€åå†™ä¸€å¥è¯", "<ans>": ""}
]

# load model
config = CPMBeeConfig.from_json_file("cpm-bee-5b.json")
ckpt_path = "cpm-bee-5b-ckpt.pt"
tokenizer = CPMBeeTokenizer()
model = CPMBeeTorch(config=config)

# load checkpoints
model.load_state_dict(torch.load(ckpt_path), strict=False)
model.cuda()

# use beam search
beam_search = CPMBeeBeamSearch(
    model=model,
    tokenizer=tokenizer,
)
for data in data_list:
    inference_results = beam_search.generate([data], max_length=100, repetition_penalty=1.1)
    for res in inference_results:
        print(res)
```

æˆ‘ä»¬è¿˜å°†ä¸Šé¢çš„ä»£ç é›†æˆåˆ°ä¸€ä¸ªpythonæ–‡ä»¶`text_generation.py`ä¸­ï¼Œä¸ºäº†ä¾¿äºæ¨ç†ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œè¯¥æ–‡ä»¶ï¼š
```bash
python text_generation.py
```
å¦‚æœæ‚¨çš„æ˜¾å­˜è¾ƒå°ï¼Œæƒ³ä½¿ç”¨BMInfè¿›è¡Œä½èµ„æºæ¨ç†:
```shell
python text_generation.py --use-bminf --memory-limit 12
```
å¦‚æœå¸Œæœ›ä½¿ç”¨CPUè¿›è¡Œæ¨ç†ï¼š
```shell
python text_generation.py --device cpu
```
å¦‚æœå¸Œæœ›åœ¨æ¨ç†æ—¶åŠ è½½å¾®è°ƒåçš„deltaæ¨¡å‹:
```shell
python text_generation.py --delta delta.pt
```

#### ä½¿ç”¨ğŸ¤—Transformers
```python
from transformers import AutoModelForCausalLM, AutoTokenizer
tokenizer = AutoTokenizer.from_pretrained("openbmb/cpm-bee-10b", trust_remote_code=True)
model = AutoModelForCausalLM.from_pretrained("openbmb/cpm-bee-10b", trust_remote_code=True).cuda()
result = model.generate({"input": "ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œ", "<ans>": ""}, tokenizer)
print(result)
```
æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŸºäºğŸ¤—Transformersçš„æ¨ç†è„šæœ¬`text_generation_hf.py`ï¼Œæ‚¨å¯ä»¥è¿è¡Œ
```shell
python text_generation_hf.py
```
å¤šå¡éƒ¨ç½²ï¼š
```shell
python text_generation_hf.py --multi-gpu
```
å¤šå¡éƒ¨ç½²çš„åŸºç¡€ä¸Šï¼ŒåŠ è½½å¾®è°ƒåçš„deltaæ¨¡å‹:
```shell
python text_generation_hf.py --multi-gpu --delta delta.pt
```


## ğŸ’« æ€§èƒ½è¡¨ç°

### é›¶æ ·æœ¬è¯„æµ‹

æˆ‘ä»¬å¯¹CPM-BeeåŸºåº§æ¨¡å‹è¿›è¡Œäº†å…¨æ–¹ä½çš„ä¸­è‹±æ–‡èƒ½åŠ›è¯„æµ‹ã€‚ åœ¨ä¸­æ–‡çš„Zero-CLUEè¯„æµ‹åŸºå‡†ä¸Šï¼ŒCPM-Beeå¯ä»¥å¤§å¹…è¶…è¶Šå…¶ä»–æ¨¡å‹ï¼Œä½åˆ—ä¸­æ–‡å¤§æ¨¡å‹ç¬¬ä¸€ã€‚åœ¨è‹±æ–‡è¯„æµ‹åŸºå‡†ä¸Šï¼ŒCPM-Beeä¹Ÿå±•ç°å‡ºäº†å’Œå¼€æºæ¨¡å‹LLaMAç›¸å½“çš„æ•ˆæœã€‚

#### ZeroCLUEä¸­æ–‡è¯„æµ‹

| **æ¨¡å‹**         | **Score**| **EPRSTMT** | **CSLDCP** | **TNEWSF** | **IFLYTEKF** | **OCNLIF** | **BUSTM** | **CHIDF** | **CSLF**  | **CLUEWSCF** |
| ---------------  | -------- |----------- | ---------- | ---------- | ------------ | ---------- | --------- | --------- | --------- | ------------ |
| **CPM-Bee**         | 78.184    | 85.52   | 58.99  | 78.2       | 58.81        | 77.73      | 83.85     | 89.65     | 83.6      | 87.24        |
| **Ctyun_Big_Model** | 76.217    | 87.25   | 48.02  | 77.13      | 59.62        | 75.5       | 90.05     | 84.6      | 82.9      | 81.72        |
| **PaddleNLP-UTC**   | 70.547    | 85.92   | 58.92  | 68.27      | 40.15        | 74.79      | 76.7      | 82.75     | 70.6      | 74.48        |
| **äºŒéƒç¥-UnifiedMC** | 70.295    | 88.71   | 50.18  | 71.67      | 40.58        | 75.5       | 80.15     | 84.85     | 60.6      | 81.72        |




#### è‹±æ–‡è¯„æµ‹

| **æ¨¡å‹**         | **Average** | **BoolQ** | **PIQA** | **SIQA** | **HellaSwag** | **WinoGrande** | **ARC-e** | **ARC-c** | **OBQA** |
| ---------------- | --------- | --------- | -------- | -------- | ------------- | -------------- | --------- | --------- | -------- |
| **GPT-3**        |       | 60.5      | 81       | -        | 78.9          | 70.2           | 68.8      | 51.4      | 57.6     |
| **Gopher**       |       | 79.3      | 81.8     | 50.6     | 79.2          | 70.1           | -         | -         | -        |
| **Chinchilla**   |       | 83.7      | 81.8     | 51.3     | 80.8          | 74.9           | -         | -         | -        |
| **PaLM**         |       | 84.8      | 80.5     | -        | 79.7          | 77             | 75.2      | 52.5      | 50.4     |
| **LLaMA-7B**     | 66.13 | 76.5      | 79.8     | 48.9     | 76.1          | 70.1           | 72.8      | 47.6      | 57.2     |
| **LLaMA-13B**    | 68.08 | 78.1      | 80.1     | 50.4     | 79.2          | 73             | 74.8      | 52.7      | 56.4     |
| **CPM-Bee** | 67.80 | 78.69     | 77.58    | 61.11    | 78.89         | 61.88          | 66.88     | 54.18     | 63.20    |



### CPM-Bee + Decoder Tuning

ä½¿ç”¨å’ŒOpenBMBå’ŒTHUNLPè”åˆè‡ªç ”çš„[Decoder Tuning](https://arxiv.org/abs/2212.08408)ï¼ˆå°†å‘è¡¨äºACL 2023ï¼‰æŠ€æœ¯ï¼Œå¯ä»¥ä»…ä»…ä½¿ç”¨APIçš„æƒ…å†µä¸‹ï¼Œä¸è®¿é—®å’Œä¿®æ”¹æ¨¡å‹å‚æ•°å³å¯å¤§å¹…æé«˜ä¸‹æ¸¸ä»»åŠ¡çš„æ€§èƒ½ã€‚
å®ç°ä»£ç [é“¾æ¥](https://github.com/thunlp/DecT)ã€‚


| **æ ·æœ¬æ•°** | **æ¨¡å‹**     | **SST2** | **IMDB** | **Yelp** | **AGNews** | **DBpedia** | **Yahoo** | **RTE** | **SNLI** | **MNLI-m** | **MNLI-mm** | **FewNERD** | **Avg.** |
| ------- | ---------- | -------- | -------- | -------- | ---------- | ----------- | --------- | ------- | -------- | ---------- | ----------- | ----------- | -------- |
| 0       | CPM-Bee    | 80.5     | 89.1     | 96.6     | 74.6       | 71.3        | 46.7      | 84.1    | 45.4     | 45.6       | 45.6        | 1.6         | 61.9     |
| 16      | T5-3B      | 89.9     | 92.7     | 94.9     | 87.7       | 96.2        | 66.5      | 55.8    | 52.0     | 52.8       | 52.2        | 51.9        | 72.1     |
|         | LLaMA-7B   | 85.1     | 90.5     | 92.8     | 71.4       | 89.8        | 45.1      | 49.1    | 35.2     | 36.3       | 36.2        | 54.6        | 62.4     |
|         | Vicuna-13B | 82.1     | 88.8     | 95.6     | 86.4       | 74.4        | 55.3      | 62.5    | 61.4     | 54.3       | 48.6        | 52.1        | 69.2     |
|         | CPM-Bee    | 92.7     | 96.2     | 97.5     | 85.5       | 89.8        | 65.2      | 86.0    | 86.4     | 76.3       | 76.3        | 54.6        | **82.4** |
| 64      | LLaMA-7B   | 87.5     | 85.7     | 96.9     | 75.4       | 93.5        | 47.4      | 51.4    | 39.4     | 36.2       | 38.4        | 59.8        | 64.7     |
|         | Vicuna-13B | 92.0     | 90.8     | 96.5     | 87.7       | 87.8        | 58.7      | 59.1    | 58.7     | 56.7       | 48.4        | 56.8        | 72.1     |
|         | CPM-Bee    | 94.3     | 96.5     | 98.3     | 88.5       | 93.5        | 68.7      | 87.1    | 88.9     | 78.0       | 79.0        | 59.8        | **84.8** |
| 256     | LLaMA-7B   | 87.6     | 88.8     | 97.1     | 82.4       | 94.2        | 48.5      | 53.4    | 39.8     | 37.3       | 37.4        | 59.1        | 66.0     |
|         | Vicuna-13B | 93.1     | 88.7     | 96.8     | 89.9       | 89.1        | 58.6      | 58.5    | 58.7     | 57.5       | 48.3        | 56.6        | 72.3     |
|         | CPM-Bee    | 94.5     | 96.7     | 98.4     | 89.7       | 94.2        | 69.9      | 87.7    | 89.4     | 81.7       | 80.6        | 59.1        | **85.6** |


## ğŸ“ƒå¼€æºåè®®

#### æ¨¡å‹åè®®
CPM-BeeåŸºåº§é‡‡ç”¨åè®®ä¸º[â€œé€šç”¨æ¨¡å‹è®¸å¯åè®®-æ¥æºè¯´æ˜-å®£ä¼ é™åˆ¶-å•†ä¸šæˆæƒâ€](https://github.com/OpenBMB/General-Model-License/blob/main/%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9E%8B%E8%AE%B8%E5%8F%AF%E5%8D%8F%E8%AE%AE-%E6%9D%A5%E6%BA%90%E8%AF%B4%E6%98%8E-%E5%AE%A3%E4%BC%A0%E9%99%90%E5%88%B6-%E5%95%86%E4%B8%9A%E6%8E%88%E6%9D%83.md)ï¼Œæœ¬æ¨¡å‹å…è®¸å•†ç”¨ï¼Œå¦‚éœ€å°†æ¨¡å‹ç”¨äºå•†ä¸šç”¨é€”ï¼Œè¯·è”ç³»cpm@modelbest.cnæ¥è·å–ä¹¦é¢æˆæƒã€‚

#### å£°æ˜
ä½œä¸ºä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼ŒCPM-Beeé€šè¿‡å­¦ä¹ å¤§é‡çš„æ–‡æœ¬æ¥ç”Ÿæˆå†…å®¹ï¼Œä½†å®ƒæ— æ³•ç†è§£ã€è¡¨è¾¾ä¸ªäººè§‚ç‚¹æˆ–ä»·å€¼åˆ¤æ–­ï¼Œå®ƒæ‰€è¾“å‡ºçš„ä»»ä½•å†…å®¹éƒ½ä¸ä»£è¡¨æ¨¡å‹å¼€å‘è€…çš„è§‚ç‚¹å’Œç«‹åœºã€‚
å› æ­¤ç”¨æˆ·åœ¨ä½¿ç”¨CPM-Beeç”Ÿæˆçš„å†…å®¹æ—¶ï¼Œåº”è‡ªè¡Œè´Ÿè´£å¯¹å…¶è¿›è¡Œè¯„ä¼°å’ŒéªŒè¯ã€‚

